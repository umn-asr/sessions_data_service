#!/bin/bash

# script/deploy: Tells Docker to run its deploy script

set -e

cd "$(dirname "$0")/.."

if [ $# -eq 0 ]; then
  echo "Provide a deploy target: script/deploy [production|staging]"
  exit 1
fi

echo "==> Deploying"

# source helper scripts
source "./script/_kamal"
source "./script/_vault"

# build and push app image to registry
vault_saml_login
ARTIFACTORY_IDENTITY_TOKEN=$(vault kv get -field="identity_token" -mount="secret" "artifactory/asrweb")
kamal registry login --destination="$1"
kamal build push --destination="$1"

# push the latest environment variables using Kamal
APP_ROLE_SECRET_PATH="auth/approle/role/app_sessions_${1}/secret-id"
VAULT_WRAPPED_SECRET=$(vault write -f -wrap-ttl=5m -field=wrapping_token "$APP_ROLE_SECRET_PATH")
kamal env push --destination="$1"

# deploy using Kamal
kamal deploy --skip-push --destination="$1"
